-- This migration script adds new columns to the vulnerability_references table that allow a better
-- interpretation of the severity of a vulnerability. The score is now reflected as a numeric property.
-- For existing data, this script tries to extract the numeric score from the original severity field.

ALTER TABLE vulnerability_references
    ADD COLUMN score    float NULL,
    ADD COLUMN vector   text  NULL;

-- A temporary function to handle the conversion of the severity field to a numeric score.
CREATE FUNCTION to_number_or_null(text) RETURNS FLOAT AS $$
DECLARE x FLOAT;
BEGIN
    x = $1::FLOAT;
    RETURN x;
EXCEPTION WHEN others THEN
    RETURN NULL;
END;
$$
STRICT
LANGUAGE plpgsql IMMUTABLE;

-- Update the score column with the numeric value of the severity field.
UPDATE vulnerability_references
SET score = to_number_or_null(severity);

-- Set severity column to NULL where it contained a numeric score value, since it is now expected to contain
-- a qualitative rating.
UPDATE vulnerability_references
SET severity = NULL
WHERE score IS NOT NULL;

-- Drop the temporary function.
DROP FUNCTION to_number_or_null;
